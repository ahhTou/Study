```
DefaultSecurityManager sm = new DefaultSecurityManager();
CustomerMd5Realm realm = new CustomerMd5Realm();

// 设置凭证器
HashedCredentialsMatcher matcher = new HashedCredentialsMatcher();
// 使用的什么算法
matcher.setHashAlgorithmName("md5");
// 散列次数
matcher.setHashIterations(1024);
realm.setCredentialsMatcher(matcher);
sm.setRealm(realm);

SecurityUtils.setSecurityManager(sm);

Subject subject = SecurityUtils.getSubject();

UsernamePasswordToken token = new UsernamePasswordToken("tou", "123");

try {
    subject.login(token);
    System.out.println("登陆成功");
} catch (AuthenticationException e) {
    e.printStackTrace();
    System.out.println("用户名错误");
}
```

# Shiro

## 关键对象

- Subject 主题： 访问系统的用户，主体可以是用户、程序等，进行认证的都称为主体;
- Principal 身份信息：是主体(subject)进行身份认证的标识，标识必须具有唯一性，如用户名、手机号、邮箱地址等一个主体可以有多个身份，但是必须有一个主身份(Primary Principal)。
- credential 凭证信息：是只有主体自己知道的安全信息，如密码、证书等。



## 配置文件

.ini文件，没有命名格式，可以放入任意文件夹中

ini 配置文件 用来学习shiro书写我们系统中的相关权限

实际项目中用不到，只是为了帮助学习shiro时候减轻压力



## 第一个Demo

```java
// 1. 创建安全管理器对象
DefaultSecurityManager securityManager = new DefaultSecurityManager();

// 2. 给安全管理器设置realms
securityManager.setRealm(new IniRealm("classpath:shiro.ini"));

// 3. SecurityUtils 全局安全的工具类, 并给其设置安全管理器
SecurityUtils.setSecurityManager(securityManager);

// 4. 关键对象 Subject 主题
Subject subject = SecurityUtils.getSubject();

// 5. 创建令牌
UsernamePasswordToken token = new UsernamePasswordToken("tou", "1123");

// 6. 通过令牌登录认证
try {
    System.out.println("认证状态 -> " + subject.isAuthenticated());
    subject.login(token);
    System.out.println("认证状态 -> " + subject.isAuthenticated());
} catch (UnknownAccountException e) {
    System.out.println("认证失败 -> 用户名不存在");
    e.printStackTrace();
} catch (IncorrectCredentialsException e) {
    System.out.println("认证失败 -> 密码错误");
    e.printStackTrace();
}
```

流程：

1. 最终执行用户名比较SimpleAccountRealm
    doGetAuthenticationInfo在这个方法中完成用户名校验

2. 最终密码校验是在AuthenticatingRealm中
    assertCredentialsMatch

总结
AuthenticatingRealm   认证realm    doGetAuthenticationInfo
AuthorizingRealm         授权realm    doGetAuthorizationInfo

## 认证

使用自定义realm

```java
public class CustomerRealm extends AuthorizingRealm {
    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) {
        return null;
    }

    /*
     * 认证
     * */
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {
        // 在token中获取用户名
        String principal = (String) token.getPrincipal();
        System.out.println(principal);
        if ("tou".equals(principal)) {
            // 参数1 返回数据库中确定用户名，2 返回数据库中的正确密码 3 当前realm的名字；
            SimpleAuthenticationInfo simpleAuthenticationInfo = new SimpleAuthenticationInfo("tou", "123", this.getName());
            return simpleAuthenticationInfo;
        }
        return null;
    }
}
```

## Md5 + Salt



使用Md5

```java
DefaultSecurityManager sm = new DefaultSecurityManager();
CustomerMd5Realm realm = new CustomerMd5Realm();

// 设置凭证器 ，如果没有进行加密可以不配置凭证器
HashedCredentialsMatcher matcher = new HashedCredentialsMatcher();
// 使用的什么算法
matcher.setHashAlgorithmName("md5");
// 散列次数, 如果没有进行散列，不加
matcher.setHashIterations(1024);
realm.setCredentialsMatcher(matcher);
sm.setRealm(realm);

SecurityUtils.setSecurityManager(sm);

Subject subject = SecurityUtils.getSubject();

UsernamePasswordToken token = new UsernamePasswordToken("tou", "123");

try {
    subject.login(token);
    System.out.println("登陆成功");
} catch (AuthenticationException e) {
    e.printStackTrace();
    System.out.println("用户名错误");
}
```

```java
@Override
protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {
    String principal = (String) token.getPrincipal();
    if ("tou".equals(principal)) {
        String password = "8dda8e350b9167ff463701743bd2c5c5";
        String salt = "X0**at";

        // 1. 数据库用户名 2 数据库md5 + salt 之后的密码 3： 注册的盐 4. 类名
        return new SimpleAuthenticationInfo(principal, password,
                ByteSource.Util.bytes(salt),
                this.getName());
    }
    return null;
}
```



## 授权

```java
public class CustomerMd5Realm extends AuthorizingRealm {
    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principal) {
        System.out.println("======== 授权 ========");
        String primaryPrincipal = (String) principal.getPrimaryPrincipal();
        System.out.println("身份信息：" + primaryPrincipal);

        // 根据身份信息 用户名 获取当前用户的角色信息， 以及权限信息
        SimpleAuthorizationInfo info = new SimpleAuthorizationInfo();

        // 将数据库中查询的角色信息赋值给权限对象
        info.addRole("admin");
        info.addRole("users");

        // 将数据库中查询的权限信息赋值给权限对象
        info.addStringPermission("user:*:01");

        return info;
    }

    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {
        String principal = (String) token.getPrincipal();
        if ("tou".equals(principal)) {
            String password = "8dda8e350b9167ff463701743bd2c5c5";
            String salt = "X0**at";

            // 1. 数据库用户名 2 数据库md5 + salt 之后的密码 3： 注册的盐 4. 类名
            return new SimpleAuthenticationInfo(principal, password,
                    ByteSource.Util.bytes(salt),
                    this.getName());
        }
        return null;
    }
}
```

判断权限

```java
// 认证用户 进行授权
if (subject.isAuthenticated()) {
    // 1. 基于角色的权限控制
    System.out.println("admin - " + subject.hasRole("admin"));
    System.out.println("users - " + subject.hasRole("users"));
    System.out.println("super - " + subject.hasRole("super"));

    // 2. 基于多角色的权限控制
    System.out.println("super & users -" + subject.hasAllRoles(Arrays.asList("admin", "super")));

    // 3. 是否含有其中一个角色
    boolean[] booleans = subject.hasRoles(Arrays.asList("admin", "super"));
    for (boolean aBoolean : booleans) {
        System.out.println(aBoolean);
    }

    // 4. 基于权限字符串的访问控制 资源标识符:操作:资源类型
    System.out.println("资源访问权限 - " + subject.isPermitted("user:*:01"));

    // 5. 分别具有那些权限
    boolean[] permitted = subject.isPermitted("user:update:01", "order:*:01");
    for (boolean b : permitted) {
        System.out.println(b);
    }

    // 6. 同时具有那些权限
    boolean permittedAll = subject.isPermittedAll("user:update:01", "order:*:01");
    System.out.println(permittedAll);
}
```

